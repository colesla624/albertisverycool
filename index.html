<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lucid Platformer 3rd Person</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; background: #0e0f1a; }
    canvas { display: block; }
    #hud {
      position: absolute; top: 10px; left: 10px;
      color: #e7e7ff; font-family: system-ui, sans-serif; font-size: 16px;
      text-shadow: 0 0 6px rgba(170,170,255,0.7);
    }
    #controls {
      position: absolute; bottom: 20px; left: 20px; right: 20px;
      display: flex; justify-content: space-between; align-items: center;
      pointer-events: auto;
    }
    .pad {
      width: 120px; height: 120px; border-radius: 60px;
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.25), rgba(255,255,255,0.08));
      position: relative; touch-action: none;
    }
    .stick {
      position: absolute; width: 60px; height: 60px; border-radius: 30px;
      background: rgba(255,255,255,0.5); top: 30px; left: 30px;
      transform: translate(0,0);
    }
    .btn {
      width: 120px; height: 120px; border-radius: 60px;
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.25), rgba(255,255,255,0.08));
      color: #fff; font-size: 20px; display: grid; place-items: center; user-select: none;
    }
  </style>
</head>
<body>
  <div id="hud">Time: 0.0s Â· Orbs: 0/5</div>
  <div id="controls">
    <div class="pad" id="movePad"><div class="stick" id="moveStick"></div></div>
    <div class="btn" id="jumpBtn">Jump</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

  <script>
    // Scene
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x10122a, 0.035);
    scene.background = new THREE.Color(0x10122a);

    // Camera (third-person follow)
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.05, 1000);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Lighting
    const hemi = new THREE.HemisphereLight(0x99aaff, 0x404070, 0.8);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xb0b8ff, 0.8);
    dir.position.set(10, 20, -10);
    scene.add(dir);

    // Materials
    const platformMat = new THREE.MeshStandardMaterial({ color: 0x6b6fde });
    const orbMat = new THREE.MeshStandardMaterial({ color: 0x9cf0ff, emissive: 0x78d4ff, emissiveIntensity: 0.8 });

    // Platforms
    const platforms = [];
    function addPlatform(x,y,z,w=6,h=0.6,d=6){
      const geo = new THREE.BoxGeometry(w,h,d);
      const mesh = new THREE.Mesh(geo, platformMat);
      mesh.position.set(x,y,z);
      scene.add(mesh);
      platforms.push({mesh,w,h,d});
      return mesh;
    }
    addPlatform(0,0,0,10,0.6,10);
    addPlatform(12,2,-6,6,0.6,6);
    addPlatform(24,4,-12,6,0.6,6);
    addPlatform(36,6,-6,9,0.6,6);
    addPlatform(48,8,0,12,0.6,8);

    // Orbs
    const orbs=[];
    function addOrb(x,y,z){
      const g=new THREE.SphereGeometry(0.35,24,24);
      const orb=new THREE.Mesh(g,orbMat);
      orb.position.set(x,y,z);
      scene.add(orb);
      orbs.push(orb);
    }
    addOrb(0,2,0);
    addOrb(24,6,-12);

    // Player avatar (simple capsule)
    const playerGeo = new THREE.CapsuleGeometry(0.5,1.2,8,16);
    const playerMat = new THREE.MeshStandardMaterial({color:0x00ff99});
    const playerMesh = new THREE.Mesh(playerGeo,playerMat);
    scene.add(playerMesh);

    const player = {
      pos:new THREE.Vector3(0,2,0),
      vel:new THREE.Vector3(0,0,0),
      yaw:0,
      radius:0.5,
      onGround:false
    };

    // Spawn on first platform
    const startPlat=platforms[0];
    const startTopY=startPlat.mesh.position.y+startPlat.h/2;
    player.pos.set(startPlat.mesh.position.x,startTopY+player.radius,startPlat.mesh.position.z);

    // Input
    const keys={};
    document.addEventListener('keydown',e=>keys[e.code]=true);
    document.addEventListener('keyup',e=>keys[e.code]=false);

    // Touch controls
    const movePad=document.getElementById('movePad');
    const moveStick=document.getElementById('moveStick');
    const jumpBtn=document.getElementById('jumpBtn');
    let moveVec={x:0,y:0};
    function setStick(dx,dy){moveStick.style.transform=`translate(${dx}px,${dy}px)`;}
    function clamp(n,max){return Math.max(-max,Math.min(max,n));}
    movePad.addEventListener('touchstart',e=>{
      const rect=movePad.getBoundingClientRect();
      moveBase={x:rect.left+rect.width/2,y:rect.top+rect.height/2};
    });
    movePad.addEventListener('touchmove',e=>{
      e.preventDefault();
      const t=e.changedTouches[0];
      const dx=clamp(t.clientX-moveBase.x,40);
      const dy=clamp(t.clientY-moveBase.y,40);
      setStick(dx,dy);
      moveVec.x=dx/40; moveVec.y=dy/40;
    },{passive:false});
    movePad.addEventListener('touchend',()=>{moveVec.x=0;moveVec.y=0;setStick(0,0);});
    jumpBtn.addEventListener('touchstart',()=>tryJump());

    function getMoveInput(){
      let mx=0,mz=0;
      if(keys['KeyW'])mz-=1;
      if(keys['KeyS'])mz+=1;
      if(keys['KeyA'])mx-=1;
      if(keys['KeyD'])mx+=1;
      mx+=moveVec.x; mz+=moveVec.y;
      const len=Math.hypot(mx,mz);
      return len>1?{x:mx/len,z:mz/len}:{x:mx,z:mz};
    }

    function tryJump(){
      if(player.onGround){
        player.vel.y=8.5; // stronger jump
        player.onGround=false;
      }
    }
    document.addEventListener('keydown',e=>{if(e.code==='Space')tryJump();});

    // Physics
    const GRAVITY=-9;
    const MOVE_SPEED=6;
    const AIR_CONTROL=0.4;

    function collidePlatforms(nextPos,vel){
      player.onGround=false;
      for(const p of platforms){
        const m=p.mesh;
        const half={x:p.w/2,y:p.h/2,z:p.d/2};
        const min=new THREE.Vector3(m.position.x-half.x,m.position.y-half.y,m.position.z-half.z);
        const max=new THREE.Vector3(m.position.x+half.x,m.position.y+half.y,m.position.z+half.z);
        const withinX=nextPos.x>(min.x-player.radius)&&nextPos.x<(max.x+player.radius);
        const withinZ=nextPos.z>(min.z-player.radius)&&nextPos.z<(max.z+player.radius);
        if(withinX&&withinZ){
          const top=max.y;
          if(vel.y<=0 && (player.pos.y-player.radius)>=top-0.05 && (nextPos.y-player.radius)<=top){
            nextPos.y=top
