<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>3D Platformer (Bug Fixed)</title>
<style>
  body { margin:0; overflow:hidden; background:#0b1026; }
  #hud { position:fixed; top:10px; left:50%; transform:translateX(-50%); color:#e9ecff; font-family:sans-serif; }
  .stick { position:fixed; bottom:16px; width:120px; height:120px; border-radius:50%; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.18); touch-action:none; }
  #stickLeft { left:16px; }
  .knob { position:absolute; left:50%; top:50%; width:54px; height:54px; border-radius:50%; transform:translate(-50%,-50%); background:rgba(97,225,255,0.35); }
  #btnJump { position:fixed; right:18px; bottom:24px; width:76px; height:76px; border-radius:50%; background:#202859; color:#e9ecff; font-size:16px; }
</style>
</head>
<body>
<div id="hud">Crystals: <span id="score">0</span></div>
<div id="stickLeft" class="stick"><div class="knob"></div></div>
<button id="btnJump">Jump</button>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script>
(() => {
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 500);
  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // Lighting
  scene.add(new THREE.HemisphereLight(0x8a5cff, 0x0b1026, 0.7));
  const dir = new THREE.DirectionalLight(0xffffff, 0.8);
  dir.position.set(20,30,10); scene.add(dir);

  // Ground
  const ground = new THREE.Mesh(new THREE.BoxGeometry(40,1,40), new THREE.MeshStandardMaterial({color:0x1b2250}));
  ground.position.y=-0.5; scene.add(ground);

  // Platforms
  const platforms=[];
  function addPlatform(x,y,z){ const m=new THREE.Mesh(new THREE.BoxGeometry(6,1,6), new THREE.MeshStandardMaterial({color:0x61e1ff})); m.position.set(x,y,z); scene.add(m); platforms.push(m); }
  addPlatform(5,2,0); addPlatform(12,4,0); addPlatform(20,6,0);

  // Crystals
  const crystals=[];
  function addCrystal(x,y,z){ const geo=new THREE.ConeGeometry(0.5,1.5,6); const mat=new THREE.MeshStandardMaterial({color:0xffd46b, emissive:0x704f10, emissiveIntensity:0.6}); const c=new THREE.Mesh(geo,mat); c.position.set(x,y+1,z); scene.add(c); crystals.push(c); }
  addCrystal(12,4,0); addCrystal(20,6,0);

  // Player
  const player={pos:new THREE.Vector3(0,1.7,2),vel:new THREE.Vector3(),radius:0.6,grounded:false};
  const pMesh=new THREE.Mesh(new THREE.SphereGeometry(player.radius,16,16), new THREE.MeshStandardMaterial({color:0xbdf4ff}));
  scene.add(pMesh);

  // Camera offset
  const camOffset=new THREE.Vector3(10,8,15);

  // Input
  const keys={left:false,right:false,up:false,down:false,space:false};
  window.addEventListener("keydown",e=>{if(e.key==="ArrowLeft"||e.key==="a")keys.left=true;if(e.key==="ArrowRight"||e.key==="d")keys.right=true;if(e.key==="ArrowUp"||e.key==="w")keys.up=true;if(e.key==="ArrowDown"||e.key==="s")keys.down=true;if(e.key===" ")keys.space=true;});
  window.addEventListener("keyup",e=>{if(e.key==="ArrowLeft"||e.key==="a")keys.left=false;if(e.key==="ArrowRight"||e.key==="d")keys.right=false;if(e.key==="ArrowUp"||e.key==="w")keys.up=false;if(e.key==="ArrowDown"||e.key==="s")keys.down=false;if(e.key===" ")keys.space=false;});

  // Touch joystick
  let moveStick={x:0,y:0};
  function setupStick(el,onMove){
    const knob=el.querySelector(".knob"); let active=false;
    el.addEventListener("touchstart",()=>{active=true;},{passive:false});
    el.addEventListener("touchmove",e=>{
      if(!active)return; const rect=el.getBoundingClientRect(); const t=e.touches[0];
      const dx=t.clientX-(rect.left+rect.width/2); const dy=t.clientY-(rect.top+rect.height/2);
      const r=50,mag=Math.hypot(dx,dy),cl=mag>r?r/mag:1; const nx=dx*cl,ny=dy*cl;
      knob.style.transform=`translate(${nx}px,${ny}px) translate(-50%,-50%)`; onMove(nx/r,ny/r); e.preventDefault();
    },{passive:false});
    el.addEventListener("touchend",()=>{active=false;knob.style.transform="translate(-50%,-50%)";onMove(0,0);});
  }
  setupStick(document.getElementById("stickLeft"),(x,y)=>{moveStick.x=x;moveStick.y=y;});

  // Jump button
  document.getElementById("btnJump").addEventListener("click",()=>{if(player.grounded){player.vel.y=5;player.grounded=false;}});

  // Score
  let score=0; const scoreEl=document.getElementById("score");

  // Collision check
  function checkGround(){
    player.grounded=false;
    if(player.pos.y<=1.7){player.pos.y=1.7;player.vel.y=0;player.grounded=true;}
    for(const p of platforms){
      const bb=new THREE.Box3().setFromObject(p);
      if(player.pos.x>bb.min.x && player.pos.x<bb.max.x && player.pos.z>bb.min.z && player.pos.z<bb.max.z){
        if(player.pos.y<=bb.max.y+player.radius && player.pos.y>=bb.max.y-0.2){
          player.pos.y=bb.max.y+player.radius; player.vel.y=0; player.grounded=true;
        }
      }
    }
  }

  // Loop
  function loop(){
    const dt=0.016; const speed=6;
    let xMove=(keys.right?1:0)-(keys.left?1:0)+moveStick.x;
    let zMove=(keys.down?1:0)-(keys.up?1:0)+moveStick.y;
    const len=Math.hypot(xMove,zMove); if(len>1){xMove/=len;zMove/=len;}
    player.pos.x+=xMove*speed*dt; player.pos.z+=zMove*speed*dt;
    player.vel.y-=9.8*dt; player.pos.y+=player.vel.y*dt;
    checkGround();

    // Reset if fall
    if(player.pos.y<-10){player.pos.set(0,1.7,2);player.vel.set(0,0,0);}

    // Player mesh
    pMesh.position.copy(player.pos);

    // Collect crystals
    for(let i=crystals.length-1;i>=0;i--){
      if(pMesh.position.distanceTo(crystals[i].position)<1.2){
        scene.remove(crystals[i]); crystals.splice(i,1); score++; scoreEl.textContent=score;
      }
    }

    // Camera follow
    camera.position.copy(player.pos.clone().add(camOffset));
    camera.lookAt(player.pos);

    renderer.render(scene,camera);
    requestAnimationFrame(loop);
  }
  loop();
})();
</script>
</body>
</html>
