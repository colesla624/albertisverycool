<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>First Person Platformer with Dual Joysticks</title>
<style>
  body { margin:0; overflow:hidden; background:#0b1026; }
  #hud { position:fixed; top:10px; left:50%; transform:translateX(-50%); color:#e9ecff; font-family:sans-serif; }
  .stick {
    position:fixed; bottom:16px; width:120px; height:120px; border-radius:50%;
    background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.18);
    touch-action:none;
  }
  #stickLeft { left:16px; }
  #stickRight { right:16px; }
  .knob {
    position:absolute; left:50%; top:50%; width:54px; height:54px; border-radius:50%;
    transform:translate(-50%,-50%); background:rgba(97,225,255,0.35);
  }
  #btnJump {
    position:fixed; right:18px; bottom:150px; width:76px; height:76px; border-radius:50%;
    background:#202859; color:#e9ecff; font-size:16px;
  }
</style>
</head>
<body>
<div id="hud">Crystals: <span id="score">0</span></div>
<div id="stickLeft" class="stick"><div class="knob"></div></div>
<div id="stickRight" class="stick"><div class="knob"></div></div>
<button id="btnJump">Jump</button>

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script>
(() => {
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 500);
  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // Lighting
  scene.add(new THREE.HemisphereLight(0x8a5cff, 0x0b1026, 0.7));
  const dir = new THREE.DirectionalLight(0xffffff, 0.8);
  dir.position.set(20,30,10); scene.add(dir);

  // Ground + platforms
  const ground = new THREE.Mesh(new THREE.BoxGeometry(40,1,40), new THREE.MeshStandardMaterial({color:0x1b2250}));
  ground.position.y=-0.5; scene.add(ground);
  const platforms=[]; function addPlatform(x,y,z){ const m=new THREE.Mesh(new THREE.BoxGeometry(6,1,6), new THREE.MeshStandardMaterial({color:0x61e1ff})); m.position.set(x,y,z); scene.add(m); platforms.push(m); }
  addPlatform(5,2,0); addPlatform(10,3,0); addPlatform(15,4,0);

  // Crystals
  const crystals=[]; function addCrystal(x,y,z){ const geo=new THREE.ConeGeometry(0.5,1.5,6); const mat=new THREE.MeshStandardMaterial({color:0xffd46b, emissive:0x704f10, emissiveIntensity:0.6}); const c=new THREE.Mesh(geo,mat); c.position.set(x,y+1,z); scene.add(c); crystals.push(c); }
  addCrystal(10,3,0); addCrystal(15,4,0);

  // Player
  const player={pos:new THREE.Vector3(0,1.7,2),vel:new THREE.Vector3(),yaw:0,pitch:0,grounded:false};
  let score=0; const scoreEl=document.getElementById("score");

  // Joysticks
  let moveStick={x:0,y:0}, lookStick={x:0,y:0};
  function setupStick(el,onMove){
    const knob=el.querySelector(".knob"); let active=false;
    el.addEventListener("touchstart",()=>{active=true;},{passive:false});
    el.addEventListener("touchmove",e=>{
      if(!active)return; const rect=el.getBoundingClientRect(); const t=e.touches[0];
      const dx=t.clientX-(rect.left+rect.width/2); const dy=t.clientY-(rect.top+rect.height/2);
      const r=50,mag=Math.hypot(dx,dy),cl=mag>r?r/mag:1; const nx=dx*cl,ny=dy*cl;
      knob.style.transform=`translate(${nx}px,${ny}px) translate(-50%,-50%)`; onMove(nx/r,ny/r); e.preventDefault();
    },{passive:false});
    el.addEventListener("touchend",()=>{active=false;knob.style.transform="translate(-50%,-50%)";onMove(0,0);});
  }
  setupStick(document.getElementById("stickLeft"),(x,y)=>{moveStick.x=x;moveStick.y=y;});
  setupStick(document.getElementById("stickRight"),(x,y)=>{lookStick.x=x;lookStick.y=y;});

  // Jump button
  function attemptJump(){ if(player.grounded){ player.vel.y=5; player.grounded=false; } }
  document.getElementById("btnJump").addEventListener("click",attemptJump);

  // Collision check
  function checkGround(){
    player.grounded=false;
    if(player.pos.y<=1.7){player.pos.y=1.7;player.vel.y=0;player.grounded=true;}
    for(const p of platforms){
      const bb=new THREE.Box3().setFromObject(p);
      if(player.pos.x>bb.min.x && player.pos.x<bb.max.x && player.pos.z>bb.min.z && player.pos.z<bb.max.z){
        if(player.pos.y<=bb.max.y+0.1 && player.pos.y>=bb.max.y-0.5){
          player.pos.y=bb.max.y; player.vel.y=0; player.grounded=true;
        }
      }
    }
  }

  // Loop
  function loop(){
    const dt=0.016; const speed=6;
    let forward=-moveStick.y; // joystick forward/back flipped
    let strafe=moveStick.x;
    const len=Math.hypot(forward,strafe); if(len>1){forward/=len;strafe/=len;}
    const cos=Math.cos(player.yaw),sin=Math.sin(player.yaw);
    player.pos.x+=(strafe*cos+forward*sin)*speed*dt;
    player.pos.z+=(strafe*-sin+forward*cos)*speed*dt;

    player.vel.y-=9.8*dt; player.pos.y+=player.vel.y*dt;
    checkGround();

    if(player.pos.y<-10){player.pos.set(0,1.7,2);player.vel.set(0,0,0);}

    // Look joystick controls yaw/pitch
    player.yaw-=lookStick.x*2.5*dt;
    player.pitch-=lookStick.y*2.0*dt;
    player.pitch=Math.max(-Math.PI/2+0.1,Math.min(Math.PI/2-0.1,player.pitch));

    // Camera in first person
    camera.position.copy(player.pos);
    camera.rotation.set(player.pitch,player.yaw,0);

    // Collect crystals
    for(let i=crystals.length-1;i>=0;i--){
      if(camera.position.distanceTo(crystals[i].position)<1.5){
        scene.remove(crystals[i]); crystals.splice(i,1); score++; scoreEl.textContent=score;
      }
    }

    renderer.render(scene,camera);
    requestAnimationFrame(loop);
  }
  loop();
})();
</script>
</body>
</html>
