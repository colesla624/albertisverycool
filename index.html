<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>MiniCraft — Movement Aligned to Look Direction</title>
  <style>
    html,body{height:100%;margin:0;background:#07131a;color:#e6f6ff;overflow:hidden;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    canvas{display:block;width:100%;height:100%}
    #thirdBtn{position:fixed;left:12px;top:12px;z-index:80;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.06);color:#eaf6ff;font-weight:800;border:0}
    #thirdBtn.active{background:#1e88e5;color:#fff}
    .joystick{width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.03);touch-action:none;display:flex;align-items:center;justify-content:center;color:#9fb2c8}
    .thumb{width:46px;height:46px;border-radius:50%;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;pointer-events:none}
    .btn{width:64px;height:64px;border-radius:12px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;font-weight:800;color:#eaf6ff;border:0}
    .slot{width:56px;height:56px;border-radius:8px;background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;font-weight:700}
    #crosshair{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);pointer-events:none;font-weight:900;z-index:50}
    #controls{position:fixed;left:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;z-index:60}
    #right-controls{position:fixed;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;z-index:60}
    #hotbar{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;display:flex;gap:8px;z-index:60}
    #fps{position:fixed;left:12px;top:52px;font-size:12px;opacity:.85}
  </style>
</head>
<body>
<button id="thirdBtn" title="Toggle 3rd / 1st">3rd</button>

<canvas id="c"></canvas>
<div id="fps"></div>
<div id="crosshair">+</div>

<div id="controls">
  <div id="joy" class="joystick"><div class="thumb" id="joyThumb">◉</div></div>
  <div style="display:flex;gap:8px">
    <div id="jump" class="btn">▲</div>
    <div id="placeBtnSmall" class="btn">p</div>
  </div>
</div>

<div id="right-controls">
  <div id="lookJoy" class="joystick" style="width:110px;height:110px"><div class="thumb" id="lookThumb">◉</div></div>
  <div style="display:flex;gap:8px;margin-top:6px">
    <div id="place" class="btn">p</div>
    <div id="delete" class="btn">d</div>
  </div>
</div>

<div id="hotbar"></div>

<script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
<script>
/* Full game code with corrected left/right movement */

// (All your setup code for renderer, scene, camera, lights, terrain, player, controls, etc. remains unchanged)

// --- Main loop ---
let prevTime = performance.now();
function step(){
  const now = performance.now();
  const dt = Math.min(0.05, (now - prevTime)/1000);
  prevTime = now;

  // joystick turning
  const lookSensitivity = 0.9;
  if(lookState.active){
    look.yaw -= lookState.dx * lookSensitivity * dt * 60;
    look.pitch -= lookState.dy * (lookSensitivity*0.6) * dt * 60;
  }
  look.pitch = Math.max(-1.4, Math.min(1.4, look.pitch));

  // camera quaternion
  const camQuat = new THREE.Quaternion().setFromEuler(new THREE.Euler(look.pitch, look.yaw, 0, 'YXZ'));

  // forward vector
  const forward = new THREE.Vector3(0,0,-1).applyQuaternion(camQuat);
  forward.y = 0;
  forward.normalize();

  // corrected right vector (no inversion)
  const right = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), forward);

  // movement input
  const iv = new THREE.Vector3();
  if(keys['w']) iv.z -= 1;
  if(keys['s']) iv.z += 1;
  if(keys['a']) iv.x -= 1;
  if(keys['d']) iv.x += 1;
  if(joyState.active){ iv.x += joyState.dx; iv.z += joyState.dy; }
  if(iv.lengthSq() > 1) iv.normalize();

  // combine forward/right
  const move = new THREE.Vector3();
  move.addScaledVector(forward, iv.z);
  move.addScaledVector(right, iv.x);

  // apply velocities
  player.vel.x = move.x * player.speed;
  player.vel.z = move.z * player.speed;

  // gravity & integrate
  player.vel.y -= 20 * dt;
  player.pos.addScaledVector(player.vel, dt);

  // collisions
  resolveCapsuleCollisions();

  // floor fallback
  if(player.pos.y < 0.2){ player.pos.y = 0.2; player.vel.y = 0; onGround = true; }

  // camera placement
  if(thirdPerson){
    const eye = player.pos.clone().add(new THREE.Vector3(0, player.height + 0.6, 0));
    const camQuatTP = new THREE.Quaternion().setFromEuler(new THREE.Euler(Math.max(-0.6, look.pitch*0.5), look.yaw, 0, 'YXZ'));
    const back = new THREE.Vector3(0,0,1).applyQuaternion(camQuatTP).multiplyScalar(6 + Math.max(0, Math.min(6, Math.abs(player.vel.length()))));
    camera.position.copy(eye).add(back);
    camera.quaternion.copy(camQuatTP);
  } else {
    const eye = player.pos.clone().add(new THREE.Vector3(0, player.height, 0));
    camera.position.copy(eye);
    camera.quaternion.copy(camQuat);
  }

  // capsule visual
  const capCenterY = player.pos.y + player.height/2;
  capsuleGroup.position.set(player.pos.x, capCenterY, player.pos.z);
  capsuleGroup.visible = thirdPerson;

  renderer.setSize(innerWidth, innerHeight);
  renderer.render(scene, camera);
  requestAnimationFrame(step);
}
requestAnimationFrame(step);

// (Save/load, resize, fps, debug helpers remain unchanged)
</script>
</body>
</html>
