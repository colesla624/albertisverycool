<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>3D FPS Game With Levels</title>
<style>
    body { margin: 0; overflow: hidden; background: #000; }
    #levelMsg {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        font-family: Arial, sans-serif;
        color: white;
        text-align: center;
        background: rgba(0,0,0,0.5);
        padding: 20px;
        border-radius: 10px;
        display: none;
    }
</style>
</head>
<body>

<div id="levelMsg"><h2>Level Complete!</h2></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>

<script>
/* ---------------------------------------------------------
   CORE VARIABLES
---------------------------------------------------------*/
let camera, scene, renderer;
let controlsEnabled = false;

const direction = new THREE.Vector3();
const speed = 8;

let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;

let colliders = [];
let goal;

/* ---------------------------------------------------------
   LEVELS
---------------------------------------------------------*/
let currentLevel = 0;
const levels = [
    {
        walls: [
            {x:0, z:-5, rot:0},
            {x:0, z:-10, rot:0},
            {x:5, z:-7, rot:Math.PI/2},
            {x:-5, z:-7, rot:Math.PI/2},
        ],
        goal: {x: 0, z: 5}
    },
    {
        walls: [
            {x:3, z:-2, rot:0},
            {x:6, z:-2, rot:0},
            {x:-3, z:-2, rot:0},
            {x:-6, z:-2, rot:0},
            {x:0, z:-7, rot:Math.PI/2},
            {x:4, z:3, rot:Math.PI/2}
        ],
        goal: {x: -8, z: 8}
    },
    {
        walls: [
            {x: 0, z:-3, rot:0},
            {x: 0, z:-6, rot:0},
            {x: 5, z:0, rot:Math.PI/2},
            {x: -5, z:0, rot:Math.PI/2},
            {x: 5, z:-10, rot:0},
            {x: -5, z:-10, rot:0},
            {x: 0, z: 4, rot:Math.PI/2},
        ],
        goal: {x: 8, z: -8}
    }
];

/* ---------------------------------------------------------
   INITIALIZE
---------------------------------------------------------*/
init();
animate();

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x202020);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 200);
    camera.position.set(0, 1.6, 5);

    renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    setupPointerLock();
    setupControls();
    createWorld();

    loadLevel(0);

    window.addEventListener("resize", onWindowResize);
}

/* ---------------------------------------------------------
   POINTER LOCK â€” auto on first click
---------------------------------------------------------*/
function setupPointerLock() {
    document.addEventListener("click", () => {
        renderer.domElement.requestPointerLock();
    });

    document.addEventListener("pointerlockchange", () => {
        controlsEnabled = (document.pointerLockElement === renderer.domElement);
    });

    document.addEventListener("mousemove", (e) => {
        if (!controlsEnabled) return;
        camera.rotation.y -= e.movementX * 0.002;
        camera.rotation.x -= e.movementY * 0.002;
        camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
    });
}

/* ---------------------------------------------------------
   INPUT MOVEMENT
---------------------------------------------------------*/
function setupControls() {
    document.addEventListener("keydown", (e) => {
        if (e.code === "KeyW") moveForward = true;
        if (e.code === "KeyS") moveBackward = true;
        if (e.code === "KeyA") moveLeft = true;
        if (e.code === "KeyD") moveRight = true;
    });

    document.addEventListener("keyup", (e) => {
        if (e.code === "KeyW") moveForward = false;
        if (e.code === "KeyS") moveBackward = false;
        if (e.code === "KeyA") moveLeft = false;
        if (e.code === "KeyD") moveRight = false;
    });
}

/* ---------------------------------------------------------
   WORLD (ground & light)
---------------------------------------------------------*/
function createWorld() {
    const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(200, 200),
        new THREE.MeshPhongMaterial({ color: 0x444444 })
    );
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
    scene.add(light);
}

/* ---------------------------------------------------------
   LOAD LEVEL
---------------------------------------------------------*/
function loadLevel(n) {
    colliders.forEach(w => scene.remove(w));
    colliders = [];

    if (goal) scene.remove(goal);

    const level = levels[n];

    const wallGeo = new THREE.BoxGeometry(4, 3, 1);
    const wallMat = new THREE.MeshPhongMaterial({ color: 0x8888ff });

    for (const w of level.walls) {
        const wall = new THREE.Mesh(wallGeo, wallMat);
        wall.position.set(w.x, 1.5, w.z);
        wall.rotation.y = w.rot;
        scene.add(wall);
        colliders.push(wall);
    }

    const goalGeo = new THREE.BoxGeometry(1, 1, 1);
    const goalMat = new THREE.MeshPhongMaterial({
        color: 0x00ff00,
        emissive: 0x00ff00
    });
    goal = new THREE.Mesh(goalGeo, goalMat);
    goal.position.set(level.goal.x, 0.5, level.goal.z);
    scene.add(goal);
}

/* ---------------------------------------------------------
   COLLISION CHECK
---------------------------------------------------------*/
function checkCollision(pos) {
    for (const wall of colliders) {
        const box = new THREE.Box3().setFromObject(wall);
        if (box.containsPoint(pos)) return true;
    }
    return false;
}

/* ---------------------------------------------------------
   LEVEL GOAL CHECK
---------------------------------------------------------*/
function checkGoal() {
    if (camera.position.distanceTo(goal.position) < 1.2) {
        completeLevel();
    }
}

function completeLevel() {
    const msg = document.getElementById("levelMsg");
    msg.style.display = "block";

    setTimeout(() => {
        msg.style.display = "none";
        currentLevel = (currentLevel + 1) % levels.length;
        loadLevel(currentLevel);
        camera.position.set(0, 1.6, 5);
    }, 1500);
}

/* ---------------------------------------------------------
   GAME LOOP
---------------------------------------------------------*/
function animate() {
    requestAnimationFrame(animate);

    if (controlsEnabled) {
        const delta = 0.016;

        direction.set(0, 0, 0);
        if (moveForward) direction.z -= 1;
        if (moveBackward) direction.z += 1;
        if (moveLeft) direction.x -= 1;
        if (moveRight) direction.x += 1;

        direction.normalize();

        const angle = camera.rotation.y;
        const dx = direction.x * Math.cos(angle) - direction.z * Math.sin(angle);
        const dz = direction.x * Math.sin(angle) + direction.z * Math.cos(angle);

        const newPos = camera.position.clone();
        newPos.x += dx * speed * delta;
        newPos.z += dz * speed * delta;

        if (!checkCollision(newPos)) {
            camera.position.copy(newPos);
        }

        checkGoal();
    }

    renderer.render(scene, camera);
}

/* ---------------------------------------------------------
   RESIZE
---------------------------------------------------------*/
function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}
</script>
</body>
</html>
