// Loop
function loop(){
  const dt = 0.016;
  const speed = 6;

  // Movement (left joystick)
  let forward = -moveStick.y; // flipped forward/back
  let strafe = moveStick.x;
  const len = Math.hypot(forward, strafe);
  if(len > 1){ forward /= len; strafe /= len; }

  const cos = Math.cos(player.yaw), sin = Math.sin(player.yaw);
  player.pos.x += (strafe * cos + forward * sin) * speed * dt;
  player.pos.z += (strafe * -sin + forward * cos) * speed * dt;

  // Gravity
  player.vel.y -= 9.8 * dt;
  player.pos.y += player.vel.y * dt;
  checkGround();

  if(player.pos.y < -10){
    player.pos.set(0,1.7,2);
    player.vel.set(0,0,0);
  }

  // ðŸ”¥ Fixed camera rotation with right joystick
  const sensitivityYaw = 2.5;   // horizontal speed
  const sensitivityPitch = 2.0; // vertical speed
  player.yaw -= lookStick.x * sensitivityYaw * dt;
  player.pitch -= lookStick.y * sensitivityPitch * dt;

  // Clamp pitch so you can't flip upside down
  const maxPitch = Math.PI/2 - 0.05;
  const minPitch = -Math.PI/2 + 0.05;
  player.pitch = Math.max(minPitch, Math.min(maxPitch, player.pitch));

  // Apply to camera
  camera.position.copy(player.pos);
  camera.rotation.set(player.pitch, player.yaw, 0);

  // Collect crystals
  for(let i=crystals.length-1;i>=0;i--){
    if(camera.position.distanceTo(crystals[i].position) < 1.5){
      scene.remove(crystals[i]);
      crystals.splice(i,1);
      score++;
      scoreEl.textContent = score;
    }
  }

  renderer.render(scene, camera);
  requestAnimationFrame(loop);
}
