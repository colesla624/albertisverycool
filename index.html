<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Second-Person 3D Platformer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <style>
    body { margin:0; overflow:hidden; background:#222; }
    canvas { display:block; }
    .hud { position:fixed; inset:0; pointer-events:none; }
    .btn, .stick-area { pointer-events:auto; touch-action:none; }
    .btn {
      position:fixed; right:20px; bottom:20px;
      width:80px; height:80px; border-radius:50%;
      background:#fff; display:flex; align-items:center; justify-content:center;
      font-weight:bold;
    }
    .stick-area {
      position:fixed; bottom:20px; width:120px; height:120px;
      border-radius:50%; background:rgba(255,255,255,0.1);
    }
    #moveStick { left:20px; }
    #lookStick { right:120px; }
    .stick-knob {
      position:absolute; left:50%; top:50%;
      width:40px; height:40px; border-radius:50%;
      background:#0af; transform:translate(-50%,-50%);
    }
  </style>
</head>
<body>
<canvas id="game"></canvas>
<div class="hud">
  <div id="moveStick" class="stick-area"><div id="moveKnob" class="stick-knob"></div></div>
  <div id="lookStick" class="stick-area"><div id="lookKnob" class="stick-knob"></div></div>
  <div id="jumpBtn" class="btn">Jump</div>
</div>

<script src="https://unpkg.com/three@0.161.0/build/three.min.js"></script>
<script>
const renderer = new THREE.WebGLRenderer({canvas:document.getElementById('game')});
renderer.setSize(window.innerWidth, window.innerHeight);
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x444466);
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
camera.position.set(0,5,10);
camera.lookAt(0,0,0);

// Lights
scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1));
const dir = new THREE.DirectionalLight(0xffffff,1);
dir.position.set(5,10,7);
scene.add(dir);

// Player
const player = new THREE.Mesh(new THREE.SphereGeometry(0.5,16,12), new THREE.MeshStandardMaterial({color:0x77ccff}));
player.position.set(0,1,0);
scene.add(player);

// NPC (camera anchor)
const npc = new THREE.Mesh(new THREE.BoxGeometry(0.8,1.6,0.8), new THREE.MeshStandardMaterial({color:0xffcc66}));
npc.position.set(-8,4,-8);
scene.add(npc);

// Platforms
const platforms = [];
function addPlatform(x,y,z,w,h,d,color=0x333333){
  const mesh = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), new THREE.MeshStandardMaterial({color}));
  mesh.position.set(x,y,z);
  scene.add(mesh);
  platforms.push(mesh);
}
addPlatform(0,0,0,8,1,8); // ground
addPlatform(5,2,0,3,1,3); // elevated
addPlatform(10,4,2,3,1,3); // goal platform

// Controls
let moveVec={x:0,y:0}, lookVec={x:0,y:0};
function setupStick(areaId, knobId, vec){
  const area=document.getElementById(areaId), knob=document.getElementById(knobId);
  let active=false,startX=0,startY=0;
  area.addEventListener('touchstart',e=>{active=true;const t=e.touches[0];startX=t.clientX;startY=t.clientY;});
  area.addEventListener('touchmove',e=>{
    if(!active)return;const t=e.touches[0];const dx=t.clientX-startX,dy=t.clientY-startY;
    const radius=area.clientWidth/2-20;const mag=Math.hypot(dx,dy);const clamp=Math.min(mag,radius);
    const nx=dx*(clamp/(mag||1)),ny=dy*(clamp/(mag||1));
    knob.style.left=`calc(50% + ${nx}px)`;knob.style.top=`calc(50% + ${ny}px)`;
    vec.x=nx/radius;vec.y=ny/radius;
  });
  area.addEventListener('touchend',()=>{active=false;vec.x=0;vec.y=0;knob.style.left='50%';knob.style.top='50%';});
}
setupStick('moveStick','moveKnob',moveVec);
setupStick('lookStick','lookKnob',lookVec);

document.getElementById('jumpBtn').addEventListener('touchstart',()=>{if(onGround)vel.y=8;});

// Physics
let vel=new THREE.Vector3(),onGround=false,yaw=0;
function update(dt){
  // Input
  yaw+=lookVec.x*dt*2;
  const forward=new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
  const right=new THREE.Vector3(forward.z,0,-forward.x);
  const desired=new THREE.Vector3().addScaledVector(forward,-moveVec.y).addScaledVector(right,moveVec.x);
  vel.x=desired.x*5;vel.z=desired.z*5;
  vel.y+=-20*dt; // gravity

  // Move
  player.position.addScaledVector(vel,dt);
  if(player.position.y<0.5){player.position.y=0.5;vel.y=0;onGround=true;}

  // Camera from NPC
  camera.position.lerp(npc.position.clone().add(new THREE.Vector3(0.5,0.8,0)),0.1);
  camera.lookAt(player.position);
}

let last=performance.now();
function animate(now){
  requestAnimationFrame(animate);
  const dt=(now-last)/1000;last=now;
  update(dt);
  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
