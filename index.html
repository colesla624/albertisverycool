<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>MiniCraft — Movement Aligned to Look Direction</title>
  <style>
    html,body{height:100%;margin:0;background:#07131a;color:#e6f6ff;overflow:hidden;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    canvas{display:block;width:100%;height:100%}
    #thirdBtn{position:fixed;left:12px;top:12px;z-index:80;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.06);color:#eaf6ff;font-weight:800;border:0}
    #thirdBtn.active{background:#1e88e5;color:#fff}
    .joystick{width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.03);touch-action:none;display:flex;align-items:center;justify-content:center;color:#9fb2c8}
    .thumb{width:46px;height:46px;border-radius:50%;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;pointer-events:none}
    .btn{width:64px;height:64px;border-radius:12px;background:rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;font-weight:800;color:#eaf6ff;border:0}
    .slot{width:56px;height:56px;border-radius:8px;background:rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center;font-weight:700}
    #crosshair{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);pointer-events:none;font-weight:900;z-index:50}
    #controls{position:fixed;left:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;z-index:60}
    #right-controls{position:fixed;right:12px;bottom:12px;display:flex;flex-direction:column;gap:8px;z-index:60}
    #hotbar{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;display:flex;gap:8px;z-index:60}
    #fps{position:fixed;left:12px;top:52px;font-size:12px;opacity:.85}
  </style>
</head>
<body>
<button id="thirdBtn" title="Toggle 3rd / 1st">3rd</button>

<canvas id="c"></canvas>
<div id="fps"></div>
<div id="crosshair">+</div>

<div id="controls">
  <div id="joy" class="joystick"><div class="thumb" id="joyThumb">◉</div></div>
  <div style="display:flex;gap:8px">
    <div id="jump" class="btn">▲</div>
    <div id="placeBtnSmall" class="btn">p</div>
  </div>
</div>

<div id="right-controls">
  <div id="lookJoy" class="joystick" style="width:110px;height:110px"><div class="thumb" id="lookThumb">◉</div></div>
  <div style="display:flex;gap:8px;margin-top:6px">
    <div id="place" class="btn">p</div>
    <div id="delete" class="btn">d</div>
  </div>
</div>

<div id="hotbar"></div>

<script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
<script>
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setClearColor(0x07131a);

const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x07131a, 0.01);

const camera = new THREE.PerspectiveCamera(72, innerWidth/innerHeight, 0.1, 1000);
const raycaster = new THREE.Raycaster();

// Lights
scene.add(new THREE.HemisphereLight(0xfff7e6, 0x081827, 0.9));
const dirLight = new THREE.DirectionalLight(0xffffff, 0.6);
dirLight.position.set(4,8,2);
scene.add(dirLight);

// World setup
const WORLD = { sizeX:32, sizeY:18, sizeZ:32, seaLevel:6 };
const total = WORLD.sizeX * WORLD.sizeY * WORLD.sizeZ;
const blocks = new Uint8Array(total);
function idx(x,y,z){ return x + WORLD.sizeX * (y + WORLD.sizeY * z); }
function noise2(x,z){ return (Math.sin(x*12.9898 + z*78.233) * 43758.5453 % 1 + Math.cos(z*6.2831 + x*3.1415)*0.5)*0.5; }

// terrain generation
for(let z=0; z<WORLD.sizeZ; z++){
  for(let x=0; x<WORLD.sizeX; x++){
    const nx = (x/WORLD.sizeX)-0.5;
    const nz = (z/WORLD.sizeZ)-0.5;
    const h = Math.floor(WORLD.seaLevel + 3*(Math.sin(nx*3.4)+Math.cos(nz*2.7)) + 1.5*(noise2(nx*3,nz*3)));
    for(let y=0;y<WORLD.sizeY;y++){
      let t=0;
      if(y<=h) t = (y > h-2) ? 1 : 2;
      blocks[idx(x,y,z)]=t;
    }
  }
}
function plantTree(cx,cz){ const gy = Math.max(5,WORLD.seaLevel+1); for(let y=gy+1;y<gy+5;y++){ if(y < WORLD.sizeY) blocks[idx(cx,y,cz)] = 3; } }
plantTree(16,14); plantTree(22,6);

// Instanced rendering
const matColors = {1:0x5fb86b, 2:0x8f8f8f, 3:0x8b5a2b};
const instanced = {};
function rebuildMeshes(){
  for(const k in instanced) if(instanced[k]){ scene.remove(instanced[k]); instanced[k].geometry.dispose(); instanced[k].material.dispose(); }
  const m = new THREE.Matrix4();
  const p = new THREE.Vector3();
  for(const type of [1,2,3]){
    let count = 0; for(let i=0;i<total;i++) if(blocks[i]===type) count++;
    if(count===0){ instanced[type]=null; continue; }
    const geo = new THREE.BoxGeometry(1,1,1);
    const mat = new THREE.MeshStandardMaterial({color:matColors[type], flatShading:true});
    const mesh = new THREE.InstancedMesh(geo, mat, count);
    let id=0;
    for(let z=0; z<WORLD.sizeZ; z++){
      for(let x=0; x<WORLD.sizeX; x++){
        for(let y=0;y<WORLD.sizeY;y++){
          if(blocks[idx(x,y,z)]!==type) continue;
          p.set(x - WORLD.sizeX/2, y, z - WORLD.sizeZ/2);
          m.makeTranslation(p.x, p.y, p.z);
          mesh.setMatrixAt(id++, m);
        }
      }
    }
    mesh.instanceMatrix.needsUpdate = true;
    scene.add(mesh);
    instanced[type] = mesh;
  }
}
rebuildMeshes();

const grid = new THREE.GridHelper(60,60,0x24323b,0x152027);
grid.rotation.x = Math.PI/2; grid.position.y = -0.5; scene.add(grid);

// Player
const player = { pos: new THREE.Vector3(0,7,0), vel: new THREE.Vector3(0,0,0), speed: 4.6, jumpSpeed: 7.5, height: 1.7, radius: 0.35 };
let onGround = false;

function worldToGrid(v){ return { x: Math.floor(v.x + WORLD.sizeX/2 + 0.0001), y: Math.floor(v.y + 0.0001), z: Math.floor(v.z + WORLD.sizeZ/2 + 0.0001) }; }
function gridToWorld(gx,gy,gz){ return new THREE.Vector3(gx - WORLD.sizeX/2, gy, gz - WORLD.sizeZ/2); }
function inWorld(x,y,z){ return x>=0 && y>=0 && z>=0 && x < WORLD.sizeX
